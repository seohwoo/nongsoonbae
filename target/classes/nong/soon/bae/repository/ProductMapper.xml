<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nong.soon.bae.repository.ProductMapper">
	<!-- 내 상점 정보 등록하기 -->
	<insert id="allShopList" parameterType="nong.soon.bae.bean.ShopListDTO">
		insert into shoplist (username, shopname, shopcontent, 
	    regdate, address) 
	    values(
	        #{username},
	        #{shopname}, 
	        #{shopcontent}, 
	        sysdate,
	        #{address} )
	</insert>	
	
	<!-- 개인 상점(테이블) 만들기 -->
	<insert id="createProduct" parameterType="String">
		create table ${username}_PRODUCT ( 
			productnum varchar2(50) primary key not null,
		    productname varchar2(1000) not null,
		    wishcount number default 0,
		    totalprice number not null,
		    productcount number not null,
		    sellcount number default 0 not null,
		    imagecount number default 0 not null,
		    content CLOB,
		    readcount number default 0 not null,
		    startdate date default sysdate not null,
		    enddate date,
		    optionstatus varchar(50) default 0 )
	</insert>

	<!-- // 개인 이미지(테이블) 만들기 -->
	<insert id="createImages" parameterType="String">
		create table ${username}_images ( 
			productnum varchar2(50) not null,
		    filename varchar2(4000) not null )
	</insert>
	
	<!-- // 상품 등록하기 -->
	<insert id="productInsert" parameterType="nong.soon.bae.bean.ProductDTO">
	    insert into ${username}_PRODUCT (productnum, productname, totalprice, 
	    productcount, imagecount, content, startdate, enddate, optionstatus) 
	    values(
	        TO_NUMBER(TO_CHAR(SYSDATE, 'YY') || #{productnum} || LPAD(${seqnum}_seq.nextval, 5, '0')),
	        #{productname}, 
	        #{totalprice}, 
	        #{productcount},
	        #{imagecount},
	        #{content}, 
	        sysdate, 
	        #{enddate}, 
	        #{optionstatus} )
	</insert>
	
	<!-- 이미지 파일 넣기 -->
	<insert id="imagesInsert" parameterType="String">
		insert into ${username}_images values (
			#{productnum},
			#{filename} )
	</insert>
	
	<!-- 상품 옵션 추가 -->
	<insert id="optionInsert" parameterType="nong.soon.bae.bean.ProductDTO">
	    insert into ${username}_PRODUCT (productnum, productname, totalprice, 
	    productcount, optionstatus) 
	    values(
	        TO_NUMBER(TO_CHAR(SYSDATE, 'YY') || #{productnum} || LPAD(${seqnum}_seq.nextval, 5, '0')),
	        #{productname}, 
	        #{totalprice}, 
	        #{productcount}, 
	        #{optionstatus} )
	</insert>
	
	<!-- 가장 최근에 상품등록한 productnum값 가져오기 -->
	<select id="selectProductnum" resultType="String" parameterType="String">
		<![CDATA[
			select productnum from 
				(select c.* , rownum r from 
				(select productnum from ${username}_product order by startdate desc) c) 
				where r = 1
		]]>
	</select>
	
	<!-- 전체 상품 테이블에 상품 등록할 때 넣을 유저의 주소 찾기 -->
	<select id="selectAddress" resultType="nong.soon.bae.bean.AreaDTO" parameterType="String">
		SELECT AREA.AREA1, AREA.AREA2 FROM shoplist 
		JOIN AREA ON shoplist.ADDRESS LIKE '%' || AREA.AREANAME || '%'
		WHERE shoplist.USERNAME = #{username}
	</select>
	
	<!-- 전체 상품 테이블에 상품 등록하기 -->
	<insert id="allProductInsert" parameterType="nong.soon.bae.bean.AllProductDTO">
		insert into ALLPRODUCT (productnum, productname, cate1, cate2, cate3,
		area1, area2, username) values (
		 	#{productnum},
		 	#{productname},
		 	#{cate1}, #{cate2}, #{cate3}, 
		 	#{area1}, #{area2},
		 	#{username}	) 	 
	</insert>
	
	<!-- 상품 등록할 때 상품 번호로 리뷰테이블 만들기 -->
	<insert id="createReviews" parameterType="String">
		create table ${productnum}_reviews ( 
			username varchar2(50),
			productnum varchar2(50),
			content varchar2(4000),
			imagecount number default 0,
			stars number default 5,
			regdate date default sysdate )
	</insert>
	
	<!-- FINISH -->

	<select id="allProduct" resultType="nong.soon.bae.bean.AllProductDTO">
		select * from allproduct 
	</select>

	<!-- 상품넘버로 유저네임찾기 -->
	<select id="selectUsername" resultType="String" parameterType="String">
		select username from allproduct where productnum=#{productnum}
	</select>

	<!-- 상품 상세정보 보기 --> 
	<select id="productDetail" resultType="nong.soon.bae.bean.ProductDTO" parameterType="String">
		select * from ${otherUsername}_product where productnum=#{productnum}
	</select>
	
	
	<select id="selectArea" resultType="nong.soon.bae.bean.AreaDTO" parameterType="String">
		select a.area1, a.area2 from allproduct a, ${otherUsername}_product p
		where a.productnum = p.productnum 
		and a.productnum = #{productnum}
	</select>
	
	<select id="selectAreaName1" resultType="String" parameterType="nong.soon.bae.bean.AreaDTO">
		select areaname from area where area1=#{area1} and area2=#{area2}
	</select>
	
	<select id="selectAreaName2" resultType="String" parameterType="nong.soon.bae.bean.AreaDTO">
		select areaname from area where area1=#{area1} and area2=#{area2}
	</select>
	
	<select id="selectName" resultType="String" parameterType="String">
		select name from users where username=#{username}
	</select>
	
	<select id="selectOption" resultType="nong.soon.bae.bean.ProductDTO" parameterType="String">
		SELECT * FROM ${otherUsername}_product WHERE optionstatus = #{optionstatus}
	</select>


	<!-- 상품 찜하기 유무 -->
	<select id="selectProductPickCount" resultType="int" parameterType="String">
		select count(*) from ${username}_mypage
		where productnum=#{productnum} and wishstatus=1
	</select>
	
	<!-- 상품 찜하기 -->
	<insert id="productPick" parameterType="String">
		insert into ${username}_mypage (username, productnum, wishstatus) 
	    values(
	        #{otherUsername}, #{productnum}, 1 )
	</insert>
	
	<!-- 찜하기 누를 때마다 상품 찜 1씩 증가  -->
	<update id="updateProductWishcount" parameterType="String">
		update ${otherUsername}_product set wishcount = wishcount + 1
		where productnum=#{productnum}
	</update>

	<!-- 상품 찜 삭제하기 -->
	<delete id="productPickDelete" parameterType="String">
		delete from ${username}_mypage where productnum=#{productnum} and wishstatus=1
	</delete>

	<!-- 찜 삭제하기 누를 때마다 상품 찜 1씩 감소  -->
	<update id="deleteProductWishcount" parameterType="String">
		update ${otherUsername}_product set wishcount = wishcount - 1
		where productnum=#{productnum}
	</update>
	
	<!-- 장바구니 상품 유무 -->
	<select id="selectProductShoppingCartCount" resultType="int" parameterType="String">
		select count(*) from ${username}_mypage
		where productnum=#{productnum} and wishstatus=2
	</select>	
	
	<!-- 장바구니 상품 담기 -->
	<insert id="productShoppingCart" parameterType="String">
		insert into ${username}_mypage (username, productnum, wishstatus) 
	    values(
	        #{otherUsername}, #{productnum}, 2 )			
	</insert>
	
	<!-- 장바구니 상품 삭제하기 -->
		<delete id="productShoppingCartDelete" parameterType="String">
		delete from ${username}_mypage where productnum=#{productnum} and wishstatus=2
	</delete>
	
	<!-- 상품 클릭시 조회수 증가 -->
	<update id="updateReadcount" parameterType="String">
		update woo_product set readcount = readcount+1 where productnum=#{productnum}
	</update>
	
	<!-- 상품 조회한 유저정보 넣기 -->
	<insert id="productReadcountInsert" parameterType="String">
		insert into productReadcount (username, productnum, regdate)
		values (#{username}, #{productnum}, sysdate )
	</insert>

	
	<!-- 오늘 상품 조회한 사람 찾기 -->
	<select id="todayProductReadcount" resultType="int" parameterType="String">
		select count(*) from productReadcount where TRUNC(regdate) = TO_DATE(#{todaydate}, 'YY/MM/DD')
		and productnum=#{productnum} and username=#{username}
	</select>
	
	
	
	
	
	
	<!-- TEST -->
	
	<select id="myProduct" resultType="nong.soon.bae.bean.ProductDTO" parameterType="String">
		select * from ${username}_PRODUCT
	</select>
	
	
	<select id="productInfo" parameterType="nong.soon.bae.bean.ProductDTO" resultType="nong.soon.bae.bean.ProductDTO">
		select * from ${username}_product where productnum=#{productnum}
	</select>
	
	
	
	
</mapper>    
    